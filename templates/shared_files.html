<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>共享文件 - 文件管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-style.css') }}">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; }
        .search { width: 300px; padding: 8px; margin-right: 10px; }
        .filter-btn { padding: 8px 16px; margin: 0 5px; cursor: pointer; }
        .filter-btn.active { background: #007bff; color: white; }
        .files-table { width: 100%; border-collapse: collapse; }
        .files-table th, .files-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .files-table th { background: #f8f9fa; font-weight: bold; }
        .action-btn { padding: 5px 10px; margin: 0 2px; cursor: pointer; border: none; border-radius: 4px; }
        .download-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>共享文件</h1>
            <p>查看和管理系统中的所有共享文件</p>
        </div>

        <div id="message"></div>

        <div class="controls">
            <input type="text" id="searchInput" class="search" placeholder="搜索文件名...">
            <button class="filter-btn active" data-filter="all">全部</button>
            <button class="filter-btn" data-filter="my">我的共享</button>
            <button class="filter-btn" data-filter="others">他人共享</button>
        </div>

        <table class="files-table">
            <thead>
                <tr>
                    <th>文件名</th>
                    <th>所有者</th>
                    <th>大小</th>
                    <th>共享时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="filesList">
                <tr><td colspan="5" style="text-align: center;">加载中...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        class SharedFilesManager {
            constructor() {
                this.files = [];
                this.filteredFiles = [];
                this.currentFilter = 'all';
                this.currentUser = null;
                this.init();
            }
            
            async init() {
                await this.loadCurrentUser();
                await this.loadSharedFiles();
                this.bindEvents();
            }
            
            async loadCurrentUser() {
                try {
                    const response = await fetch('/api/auth/user/info');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.currentUser = data.user.email.split('@')[0];
                        }
                    }
                } catch (error) {
                    console.log('无法获取当前用户信息');
                }
            }
            
            async loadSharedFiles() {
                try {
                    const response = await fetch('/api/sharing/shared');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.files = data.data;
                            this.applyFilter();
                            this.renderFiles();
                        } else {
                            this.showMessage(data.message, 'error');
                        }
                    } else {
                        this.showMessage('加载共享文件失败', 'error');
                    }
                } catch (error) {
                    this.showMessage('网络错误，请稍后重试', 'error');
                }
            }
            
            bindEvents() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterFiles(e.target.value);
                });
                
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                        this.applyFilter();
                        this.renderFiles();
                    });
                });
            }
            
            applyFilter() {
                switch (this.currentFilter) {
                    case 'my':
                        this.filteredFiles = this.files.filter(file => file.owner === this.currentUser);
                        break;
                    case 'others':
                        this.filteredFiles = this.files.filter(file => file.owner !== this.currentUser);
                        break;
                    default:
                        this.filteredFiles = this.files;
                }
            }
            
            filterFiles(searchTerm) {
                const filtered = this.filteredFiles.filter(file => 
                    file.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    file.owner.toLowerCase().includes(searchTerm.toLowerCase())
                );
                this.renderFiles(filtered);
            }
            
            renderFiles(filesToRender = this.filteredFiles) {
                const tbody = document.getElementById('filesList');
                
                if (filesToRender.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无共享文件</td></tr>';
                    return;
                }
                
                tbody.innerHTML = filesToRender.map(file => this.renderFileRow(file)).join('');
                this.bindActionEvents();
            }
            
            renderFileRow(file) {
                const canDelete = this.currentUser === file.owner || this.currentUser === 'admin';
                const fileSize = this.formatFileSize(file.size);
                const fileDate = new Date(file.modified_time * 1000).toLocaleDateString('zh-CN');
                
                return `
                    <tr data-filename="${file.name}" data-owner="${file.owner}">
                        <td>${file.name}</td>
                        <td>${file.owner}</td>
                        <td>${fileSize}</td>
                        <td>${fileDate}</td>
                        <td>
                            <button class="action-btn download-btn" title="下载">下载</button>
                            ${canDelete ? `<button class="action-btn delete-btn" title="删除">删除</button>` : ''}
                        </td>
                    </tr>
                `;
            }
            
            bindActionEvents() {
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const row = e.target.closest('tr');
                        const filename = row.dataset.filename;
                        const owner = row.dataset.owner;
                        this.downloadFile(filename, owner);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const row = e.target.closest('tr');
                        const filename = row.dataset.filename;
                        const owner = row.dataset.owner;
                        this.deleteFile(filename, owner);
                    });
                });
            }
            
            async downloadFile(filename, owner) {
                try {
                    const response = await fetch(`/api/download/shared/${owner}/${filename}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        this.showMessage(`文件 ${filename} 下载开始`, 'success');
                    } else {
                        this.showMessage('下载失败，请稍后重试', 'error');
                    }
                } catch (error) {
                    this.showMessage('下载失败，请稍后重试', 'error');
                }
            }
            
            async deleteFile(filename, owner) {
                if (!confirm(`确定要删除共享文件 "${filename}" 吗？`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/sharing/delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: filename,
                            owner: owner
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showMessage(data.message, 'success');
                        await this.loadSharedFiles();
                    } else {
                        this.showMessage(data.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('删除失败，请稍后重试', 'error');
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            showMessage(message, type = 'error') {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = message;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new SharedFilesManager();
        });
    </script>
</body>
</html>
